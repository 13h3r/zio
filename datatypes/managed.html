<html><head><title>: Managed</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="ZIO contributors" /><meta name="description" content="Type-safe, composable asynchronous and concurrent programming for Scala" /><meta name="og:image" content="/scalaz-zio/img/poster.png" /><meta name="image" property="og:image" content="/scalaz-zio/img/poster.png" /><meta name="og:title" content=": Managed" /><meta name="title" property="og:title" content=": Managed" /><meta name="og:site_name" content="" /><meta name="og:url" content="https://scalaz.github.io/scalaz-zio/" /><meta name="og:type" content="website" /><meta name="og:description" content="Type-safe, composable asynchronous and concurrent programming for Scala" /><link rel="icon" type="image/png" href="/scalaz-zio/img/favicon.png" /><meta name="twitter:title" content=": Managed" /><meta name="twitter:image" content="/scalaz-zio/img/poster.png" /><meta name="twitter:description" content="Type-safe, composable asynchronous and concurrent programming for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="512x512" href="/scalaz-zio/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/scalaz-zio/highlight/styles/default.css" /><link rel="stylesheet" href="/scalaz-zio/css/style.css" /><link rel="stylesheet" href="/scalaz-zio/css/palette.css" /><link rel="stylesheet" href="/scalaz-zio/css/codemirror.css" /><link rel="stylesheet" href="/scalaz-zio/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/scalaz-zio/" class="brand"><div class="brand-wrapper"><span></span></div></a></li>  <li><a href="/scalaz-zio/datatypes/" class="">Data Types</a> <ul class="sub_section"> <li><a href="/scalaz-zio/datatypes/fiber.html" class="">Fiber</a></li> <li><a href="/scalaz-zio/datatypes/fiberlocal.html" class="">FiberLocal</a></li> <li><a href="/scalaz-zio/datatypes/io.html" class="">IO</a></li> <li><a href="/scalaz-zio/datatypes/managed.html" class=" active ">Managed</a></li> <li><a href="/scalaz-zio/datatypes/promise.html" class="">Promise</a></li> <li><a href="/scalaz-zio/datatypes/queue.html" class="">Queue</a></li> <li><a href="/scalaz-zio/datatypes/ref.html" class="">Ref</a></li> <li><a href="/scalaz-zio/datatypes/schedule.html" class="">Schedule</a></li> <li><a href="/scalaz-zio/datatypes/semaphore.html" class="">Semaphore</a></li> <li><a href="/scalaz-zio/datatypes/stream.html" class="">Stream</a></li></ul></li>   </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/scalaz/scalaz-zio"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/scalaz/scalaz-zio"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="scalaz" data-github-repo="scalaz-zio"><div class="content-wrapper"><section><h1 id="managed">Managed</h1>

<p><code class="highlighter-rouge">Managed</code> is a data structure that encapsulates the acquisition and the release of a resource.</p>

<p>A <code class="highlighter-rouge">Managed[E, A]</code> is a managed resource of type <code class="highlighter-rouge">A</code>, which may be used by invoking the <code class="highlighter-rouge">use</code> method of the resource. The resource will be automatically acquired before the resource is used, and automatically released after the resource is used.</p>

<p>Resources do not survive the scope of <code class="highlighter-rouge">use</code>, meaning that if you attempt to capture the resource, leak it from <code class="highlighter-rouge">use</code>, and then use it after the resource has been consumed, the resource will not be valid anymore and may fail with some checked error, as per the type of the functions provided by the resource.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scalaz.zio._</span>
<span class="k">def</span> <span class="n">doSomething</span><span class="o">(</span><span class="n">queue</span><span class="k">:</span> <span class="kt">Queue</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">UIO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">unit</span>

<span class="k">val</span> <span class="n">resource</span> <span class="k">=</span> <span class="nc">Managed</span><span class="o">.</span><span class="n">make</span><span class="o">(</span><span class="nc">Queue</span><span class="o">.</span><span class="n">unbounded</span><span class="o">[</span><span class="kt">Int</span><span class="o">])(</span><span class="k">_</span><span class="o">.</span><span class="n">shutdown</span><span class="o">)</span>
<span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">UIO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">use</span> <span class="o">{</span> <span class="n">queue</span> <span class="k">=&gt;</span> <span class="n">doSomething</span><span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">}</span>
</code></pre></div></div>

<p>In this example, the queue will be created when <code class="highlighter-rouge">use</code> is called, and <code class="highlighter-rouge">shutdown</code> will be called when <code class="highlighter-rouge">doSomething</code> completes.</p>

<h2 id="creating-a-managed">Creating a Managed</h2>

<p>As shown in the previous example, a <code class="highlighter-rouge">Managed</code> can be created by passing an <code class="highlighter-rouge">acquire</code> function and a <code class="highlighter-rouge">release</code> function.</p>

<p>It can also be created from an effect. In this case the release function will do nothing.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scalaz.zio._</span>
<span class="k">def</span> <span class="n">acquire</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">succeedLazy</span><span class="o">(???)</span>

<span class="k">val</span> <span class="n">resource</span><span class="k">:</span> <span class="kt">Managed</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Managed</span><span class="o">.</span><span class="n">fromEffect</span><span class="o">(</span><span class="n">acquire</span><span class="o">)</span>
</code></pre></div></div>

<p>You can create a <code class="highlighter-rouge">Managed</code> from a pure value as well.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scalaz.zio._</span>
<span class="k">val</span> <span class="n">resource</span><span class="k">:</span> <span class="kt">Managed</span><span class="o">[</span><span class="kt">Nothing</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Managed</span><span class="o">.</span><span class="n">succeed</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="managed-with-zio-environment">Managed with ZIO environment</h2>

<p><code class="highlighter-rouge">Managed[E, A]</code> is actually an alias for <code class="highlighter-rouge">ZManaged[Any, E, A]</code>. If youâ€™d like your <code class="highlighter-rouge">acquire</code>, <code class="highlighter-rouge">release</code> or <code class="highlighter-rouge">use</code> functions to require an environment R, just use <code class="highlighter-rouge">ZManaged</code> instead of <code class="highlighter-rouge">Managed</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scalaz.zio._</span>
<span class="k">import</span> <span class="nn">scalaz.zio.console._</span>

<span class="k">val</span> <span class="n">resource</span><span class="k">:</span> <span class="kt">ZManaged</span><span class="o">[</span><span class="kt">Console</span>, <span class="kt">Nothing</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ZManaged</span><span class="o">.</span><span class="n">make</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">"acquiring"</span><span class="o">))(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">console</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">"releasing"</span><span class="o">))</span>
<span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Console</span>, <span class="kt">Nothing</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">use</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">console</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">"running"</span><span class="o">)</span> <span class="o">}</span>
</code></pre></div></div>

<h2 id="combining-managed">Combining Managed</h2>

<p>It is possible to combine multiple <code class="highlighter-rouge">Managed</code> using <code class="highlighter-rouge">flatMap</code> to obtain a single <code class="highlighter-rouge">Managed</code> that will acquire and release all the resources.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scalaz.zio._</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">managedQueue</span><span class="k">:</span> <span class="kt">Managed</span><span class="o">[</span><span class="kt">Nothing</span>, <span class="kt">Queue</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Managed</span><span class="o">.</span><span class="n">make</span><span class="o">(</span><span class="nc">Queue</span><span class="o">.</span><span class="n">unbounded</span><span class="o">[</span><span class="kt">Int</span><span class="o">])(</span><span class="k">_</span><span class="o">.</span><span class="n">shutdown</span><span class="o">)</span>
<span class="k">val</span> <span class="n">managedFile</span><span class="k">:</span> <span class="kt">Managed</span><span class="o">[</span><span class="kt">IOException</span>, <span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Managed</span><span class="o">.</span><span class="n">make</span><span class="o">(</span><span class="n">openFile</span><span class="o">(</span><span class="s">"data.json"</span><span class="o">))(</span><span class="n">closeFile</span><span class="o">)</span>

<span class="k">val</span> <span class="n">combined</span><span class="k">:</span> <span class="kt">Managed</span><span class="o">[</span><span class="kt">IOException</span>, <span class="o">(</span><span class="kt">Queue</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>, <span class="kt">File</span><span class="o">)]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">queue</span> <span class="k">&lt;-</span> <span class="n">managedQueue</span>
    <span class="n">file</span>  <span class="k">&lt;-</span> <span class="n">managedFile</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">file</span><span class="o">)</span>

<span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">IOException</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">use</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">file</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">doSomething</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">file</span><span class="o">)</span> <span class="o">}</span>

</code></pre></div></div>

<h2 id="reservation">Reservation</h2>

<p>Unlike <code class="highlighter-rouge">Managed</code>, <code class="highlighter-rouge">Reservation</code> does not bind <code class="highlighter-rouge">release</code> to <code class="highlighter-rouge">acquire</code> allowing interruptible resource acquisition.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scalaz.zio._</span>
</code></pre></div></div>

<p>Whilst having more control, a concurrency primitive such as <code class="highlighter-rouge">Promise</code> may be needed to help properly manage resource state and clean up.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">data</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">IOException</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">p</span> <span class="k">&lt;-</span> <span class="nc">Promise</span><span class="o">.</span><span class="n">make</span><span class="o">[</span><span class="kt">IOException</span>,<span class="kt">File</span><span class="o">]</span>
  <span class="n">res</span> <span class="k">=</span> <span class="nc">Reservation</span><span class="o">(</span><span class="n">openFile</span><span class="o">(</span><span class="s">"x"</span><span class="o">,</span> <span class="n">p</span><span class="o">),</span> <span class="n">closeFile</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
  <span class="n">result</span> <span class="k">&lt;-</span> <span class="o">(</span><span class="k">for</span> <span class="o">{</span>
      <span class="n">fiber</span>  <span class="k">&lt;-</span> <span class="n">res</span><span class="o">.</span><span class="n">acquire</span><span class="o">.</span><span class="n">fork</span>
      <span class="n">ex</span>     <span class="k">&lt;-</span> <span class="n">fiber</span><span class="o">.</span><span class="n">interrupt</span>
      <span class="n">data</span>   <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">toEither</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="n">e</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">.</span><span class="n">fail</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptedIOException</span><span class="o">(</span><span class="s">"Stop!"</span><span class="o">)),</span> <span class="n">file</span> <span class="k">=&gt;</span> <span class="n">readFile</span><span class="o">(</span><span class="n">file</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">data</span><span class="o">).</span><span class="n">ensuringR</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="n">release</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/scalaz-zio/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'scalaz/scalaz-zio'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/scalaz-zio/js/main.js"></script></body></html>